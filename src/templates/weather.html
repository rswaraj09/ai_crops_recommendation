<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mumbai Historical Weather Data</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
        }
        
        header {
            background: linear-gradient(135deg, #1e5799, #207cca);
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin: 0;
            font-size: 2.2rem;
        }
        
        .subtitle {
            font-style: italic;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .card {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        
        .card-header {
            background-color: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .card-title {
            margin: 0;
            color: #2c3e50;
            font-size: 1.2rem;
        }
        
        .card-body {
            padding: 20px;
            height: 300px;
            position: relative;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .temperature { color: #e74c3c; }
        .rainfall { color: #3498db; }
        .humidity { color: #2ecc71; }
        .wind { color: #9b59b6; }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            border-top: 1px solid #eee;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .fetch-button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 1rem;
            color: white;
            background-color: #207cca;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .fetch-button:hover {
            background-color: #1e5799;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>AgriGenius- Weather Recommendation System</h1>
            <!-- <div class="subtitle">Historical Weather Data - Past 12 Months</div> -->
        </div>
    </header>
    
    <div class="container">
        <button class="fetch-button" onclick="fetchClimaticConditions()">Fetch Climatic Conditions</button>
        <div class="stats-container">
            <!-- Removed Total Rainfall card -->
            <!-- Removed Highest Humidity card -->
            <!-- Removed Max Wind Speed card -->
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <h3>Current Temperature</h3>
                <div class="stat-value temperature" id="currentTemperature">Loading...</div>
                <div id="temperatureDate"></div>
            </div>
            <div class="stat-card">
                <h3>Current Rainfall</h3>
                <div class="stat-value rainfall" id="currentRainfall">Loading...</div>
                <div id="rainfallDate"></div>
            </div>
            <div class="stat-card">
                <h3>Current Humidity</h3>
                <div class="stat-value humidity" id="currentHumidity">Loading...</div>
                <div id="humidityDate"></div>
            </div>
            <div class="stat-card">
                <h3>Current Wind Speed</h3>
                <div class="stat-value wind" id="currentWindSpeed">Loading...</div>
                <div id="windSpeedDate"></div>
            </div>
        </div>
        
        <div class="dashboard">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Temperature Trends (째C)</h3>
                </div>
                <div class="card-body">
                    <canvas id="temperatureChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Monthly Rainfall (mm)</h3>
                </div>
                <div class="card-body">
                    <canvas id="rainfallChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Average Humidity (%)</h3>
                </div>
                <div class="card-body">
                    <canvas id="humidityChart"></canvas>
                </div>
            </div>
            
            <div class="card" style="grid-column: 1 / -1; width: 100%; margin: 0 auto;">
                <div class="card-header">
                    <h3 class="card-title">Wind Speed (km/h)</h3>
                </div>
                <div class="card-body">
                    <canvas id="windChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <!-- Removed Data Source and Last Updated text -->
        </div>

        <!-- Add Seasonal Crop Recommendations button -->
        <div style="text-align: center; margin-top: 20px;">
            <button class="fetch-button" style="font-size: 1.2rem; padding: 15px 30px;" onclick="showCropRecommendations()">Seasonal Crop Recommendations</button>
        </div>

        <div id="cropRecommendationsUI" style="display: none; margin-top: 20px;">
            <h2 style="text-align: center;">Seasonal Crop Recommendations</h2>
            <p style="text-align: center;">Select any date to see recommended crops based on historical climate data for that month.</p>
            <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 20px;">
                <div style="flex: 1; min-width: 300px; max-width: 400px; border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
                    <h3>Select Planting Date</h3>
                    <label for="plantingDate">Date</label>
                    <input type="date" id="plantingDate" style="width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px;" onchange="updateSelectedMonth()">
                    
                    <!-- Added District Input -->
                    <label for="districtInput" style="margin-top: 20px; display: block;">District</label>
                    <input type="text" id="districtInput" placeholder="Enter District" style="width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #ccc; border-radius: 4px;">
                    
                    <div style="margin-top: 20px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
                        <h4>Selected Month Information</h4>
                        <p><strong>Month:</strong> <span id="selectedMonth">March</span></p>
                        <p><strong>Season:</strong> <span id="selectedSeason">Summer</span></p>
                    </div>
                    <div style="margin-top: 20px; padding: 10px; background: #f9f9f9; border-radius: 4px;">
                        <h4>Historical Climate Data</h4>
                        <p><strong>Temperature:</strong> <span id="historicalTemperature">28-35째C</span></p>
                        <p><strong>Rainfall:</strong> <span id="historicalRainfall">Very Low</span></p>
                        <p><strong>Humidity:</strong> <span id="historicalHumidity">25-35%</span></p>
                    </div>
                </div>
                <div style="flex: 2; min-width: 300px; max-width: 600px; border: 1px solid #ddd; border-radius: 8px; padding: 20px; background: #fff; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
                    <h3>Recommended Crops for <span id="recommendedMonth">March</span></h3>
                    <div class="recommended-crops" style="margin-top: 10px;">Loading...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Months array for all charts
        const months = ['Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Jan', 'Feb', 'Mar'];
        
        // Temperature Data (Average, Min, Max)
        const temperatureData = {
            average: [30.5, 32.8, 31.2, 29.4, 28.6, 29.2, 31.5, 32.3, 29.8, 28.2, 29.5, 31.7],
            min: [24.2, 26.5, 25.8, 25.2, 24.8, 24.3, 25.1, 24.9, 22.6, 21.3, 22.8, 24.5],
            max: [34.7, 38.2, 36.4, 33.2, 32.5, 33.8, 36.2, 36.9, 34.2, 32.5, 33.7, 36.3]
        };
        
        // Monthly Rainfall Data
        const rainfallData = [45, 13.5, 498.2, 827.4, 585.6, 312.8, 76.3, 22.1, 5.2, 3.8, 8.4, 108.7];
        
        // Humidity Data
        const humidityData = {
            morning: [78, 75, 88, 92, 95, 91, 83, 79, 75, 70, 72, 76],
            evening: [65, 63, 78, 86, 89, 84, 72, 68, 63, 58, 60, 64]
        };
        
        // Wind Speed Data
        const windData = {
            average: [8.2, 9.6, 12.4, 15.8, 18.2, 14.5, 10.3, 8.9, 7.6, 6.9, 7.3, 8.8],
            gusts: [23.5, 28.4, 42.6, 56.3, 76.0, 48.2, 32.5, 27.3, 22.8, 19.5, 21.2, 24.7]
        };
        
        function fetchClimaticConditions() {
            const apiKey = '0e87a9fa187a73fbe30f3eff6bb1332b';
            const city = 'Mumbai';
            const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`;

            // Set loading state
            document.getElementById('currentTemperature').textContent = 'Fetching...';
            document.getElementById('currentRainfall').textContent = 'Fetching...';
            document.getElementById('currentHumidity').textContent = 'Fetching...';
            document.getElementById('currentWindSpeed').textContent = 'Fetching...';

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    const temperature = data.main.temp;
                    const humidity = data.main.humidity;
                    const windSpeed = data.wind.speed;
                    const rainfall = data.rain ? data.rain['1h'] : 0; // Rainfall in the last hour

                    document.getElementById('currentTemperature').textContent = `${temperature}째C`;
                    document.getElementById('temperatureDate').textContent = `Updated on ${new Date().toLocaleString()}`;

                    document.getElementById('currentRainfall').textContent = `${rainfall} mm`;
                    document.getElementById('rainfallDate').textContent = `Updated on ${new Date().toLocaleString()}`;

                    document.getElementById('currentHumidity').textContent = `${humidity}%`;
                    document.getElementById('humidityDate').textContent = `Updated on ${new Date().toLocaleString()}`;

                    document.getElementById('currentWindSpeed').textContent = `${windSpeed} km/h`;
                    document.getElementById('windSpeedDate').textContent = `Updated on ${new Date().toLocaleString()}`;

                    // Delay chart rendering by 2 seconds
                    setTimeout(() => {
                        renderCharts();
                    }, 2000);
                })
                .catch(error => {
                    console.error('Error fetching weather data:', error);
                    document.getElementById('currentTemperature').textContent = 'Error';
                    document.getElementById('currentRainfall').textContent = 'Error';
                    document.getElementById('currentHumidity').textContent = 'Error';
                    document.getElementById('currentWindSpeed').textContent = 'Error';
                });
        }

        function renderCharts() {
            // Create Temperature Chart
            const temperatureCtx = document.getElementById('temperatureChart').getContext('2d');
            new Chart(temperatureCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Maximum',
                            data: temperatureData.max,
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.3,
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: 'Average',
                            data: temperatureData.average,
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            tension: 0.3,
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: 'Minimum',
                            data: temperatureData.min,
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.3,
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Temperature (째C)'
                            }
                        }
                    }
                }
            });

            // Create Rainfall Chart
            const rainfallCtx = document.getElementById('rainfallChart').getContext('2d');
            new Chart(rainfallCtx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Rainfall',
                        data: rainfallData,
                        backgroundColor: 'rgba(52, 152, 219, 0.7)',
                        borderColor: 'rgba(41, 128, 185, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Rainfall (mm)'
                            }
                        }
                    }
                }
            });

            // Create Humidity Chart
            const humidityCtx = document.getElementById('humidityChart').getContext('2d');
            new Chart(humidityCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Morning',
                            data: humidityData.morning,
                            borderColor: '#27ae60',
                            backgroundColor: 'rgba(39, 174, 96, 0.1)',
                            tension: 0.3,
                            borderWidth: 2,
                            fill: true
                        },
                        {
                            label: 'Evening',
                            data: humidityData.evening,
                            borderColor: '#16a085',
                            backgroundColor: 'rgba(22, 160, 133, 0.1)',
                            tension: 0.3,
                            borderWidth: 2,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: 50,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Humidity (%)'
                            }
                        }
                    }
                }
            });

            // Create Wind Speed Chart
            const windCtx = document.getElementById('windChart').getContext('2d');
            new Chart(windCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Average Speed',
                            data: windData.average,
                            borderColor: '#9b59b6',
                            backgroundColor: 'rgba(155, 89, 182, 0.1)',
                            tension: 0.3,
                            borderWidth: 2,
                            fill: false
                        },
                        {
                            label: 'Maximum Gusts',
                            data: windData.gusts,
                            borderColor: '#8e44ad',
                            backgroundColor: 'rgba(142, 68, 173, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.3,
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Wind Speed (km/h)'
                            }
                        }
                    }
                }
            });
        }

        function showCropRecommendations() {
            const cropUI = document.getElementById('cropRecommendationsUI');
            cropUI.style.display = cropUI.style.display === 'none' ? 'block' : 'none';
        }

        async function fetchDataset() {
            const response = await fetch('seasonal_climate_crop_data_mapped.csv');
            const data = await response.text();
            const rows = data.split('\n').slice(1); // Skip the header row
            const dataset = rows.map(row => {
                const [District, Month, Season, Temperature, Rainfall, Humidity, RecommendedCrops] = row.split(',');
                return { District, Month, Season, Temperature, Rainfall, Humidity, RecommendedCrops };
            });
            return dataset;
        }

        async function updateSelectedMonth() {
            const plantingDate = document.getElementById('plantingDate').value;
            const district = document.getElementById('districtInput').value.trim();

            if (!plantingDate || !district) {
                alert('Please provide both planting date and district.');
                return;
            }

            const date = new Date(plantingDate);
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const selectedMonth = monthNames[date.getMonth()];
            document.getElementById('selectedMonth').textContent = selectedMonth;

            try {
                console.log(`Sending request - District: ${district}, Month: ${selectedMonth}`); // Debug log
                const response = await fetch('/get_recommendation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ district, month: selectedMonth })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }

                const data = await response.json();
                console.log('Response received:', data); // Debug log

                document.getElementById('selectedSeason').textContent = data.season;
                document.getElementById('historicalTemperature').textContent = data.temperature;
                document.getElementById('historicalRainfall').textContent = data.rainfall;
                document.getElementById('historicalHumidity').textContent = data.humidity;
                document.getElementById('recommendedMonth').textContent = selectedMonth;

                const crops = data.recommended_crops.split(', ').join(', ');
                document.querySelector('.recommended-crops').innerHTML = crops;
            } catch (error) {
                console.error('Error fetching recommendation:', error);
                alert(`An error occurred while fetching the recommendation: ${error.message}`);
                document.getElementById('selectedSeason').textContent = 'N/A';
                document.getElementById('historicalTemperature').textContent = 'N/A';
                document.getElementById('historicalRainfall').textContent = 'N/A';
                document.getElementById('historicalHumidity').textContent = 'N/A';
                document.querySelector('.recommended-crops').innerHTML = 'Error fetching data';
            }
        }

        async function getRecommendation() {
            const plantingDate = document.getElementById('plantingDate').value;
            const district = document.getElementById('districtInput').value.trim();

            if (!plantingDate || !district) {
                alert('Please provide both planting date and district.');
                return;
            }

            const date = new Date(plantingDate);
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            const selectedMonth = monthNames[date.getMonth()];
            document.getElementById('selectedMonth').textContent = selectedMonth;

            const response = await fetch('/get_recommendation', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ district, month: selectedMonth })
            });

            const data = await response.json();

            if (response.ok) {
                document.getElementById('recommendationOutput').innerHTML = `
                    <p><strong>Season:</strong> ${data.season}</p>
                    <p><strong>Temperature:</strong> ${data.temperature}</p>
                    <p><strong>Rainfall:</strong> ${data.rainfall}</p>
                    <p><strong>Humidity:</strong> ${data.humidity}</p>
                    <p><strong>Recommended Crops:</strong> ${data.recommended_crops}</p>
                `;
            } else {
                document.getElementById('recommendationOutput').innerHTML = `<p>${data.error}</p>`;
            }
        }

        async function fetchRecommendation() {
            const district = document.getElementById('districtInput').value.trim();
            const month = document.getElementById('monthInput').value.trim();

            if (!district || !month) {
                alert('Please provide both district and month.');
                return;
            }

            try {
                console.log(`Sending request - District: ${district}, Month: ${month}`); // Debug log
                const response = await fetch('/get_recommendation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ district, month })
                });

                const data = await response.json();
                console.log('Response received:', data); // Debug log

                const outputDiv = document.getElementById('recommendationOutput');
                const detailsDiv = document.getElementById('recommendationDetails');
                outputDiv.style.display = 'block';

                if (response.ok) {
                    detailsDiv.innerHTML = `
                        <p><strong>Season:</strong> ${data.season}</p>
                        <p><strong>Temperature:</strong> ${data.temperature}</p>
                        <p><strong>Rainfall:</strong> ${data.rainfall}</p>
                        <p><strong>Humidity:</strong> ${data.humidity}</p>
                        <p><strong>Recommended Crops:</strong> ${data.recommended_crops}</p>
                    `;
                } else {
                    detailsDiv.innerHTML = `<p>${data.error}</p>`;
                }
            } catch (error) {
                console.error('Error fetching recommendation:', error);
                alert('An error occurred while fetching the recommendation.');
            }
        }
    </script>
</body>
</html>